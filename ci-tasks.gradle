import org.gradle.internal.os.OperatingSystem

def androidHome = System.getenv("ANDROID_HOME") ?: System.getenv("ANDROID_SDK_ROOT")
def emulator = "${androidHome}/emulator/emulator"
def avdManager = "${androidHome}/cmdline-tools/latest/bin/avdmanager"
def sdkManager = "${androidHome}/cmdline-tools/latest/bin/sdkmanager"
def homeDir = System.getenv("HOME")

task installSystemImage(type: Exec) {
    commandLine sdkManager, "--install", "system-images;android-33;google_apis;x86_64"
}

task createEmulator(type: Exec) {
    dependsOn installSystemImage

    doFirst {
        exec {
            commandLine "bash", "-c", "mkdir -p ${homeDir}/.android/avd"
        }
    }

    commandLine avdManager, "create", "avd",
            "--force",
            "--name", "CI_API_33",
            "--package", "system-images;android-33;google_apis;x86_64",
            "--device", "pixel"
}

task startEmulator {
    dependsOn createEmulator

    doLast {
        exec {
            commandLine emulator,
                    "@CI_API_33",
                    "-no-window",
                    "-no-audio",
                    "-no-boot-anim",
                    "-gpu", "swiftshader_indirect",
                    "-no-snapshot"
        }
    }
}

task waitForBoot(type: Exec) {
    dependsOn startEmulator

    commandLine "bash", "-c", """
        adb wait-for-device
        until [[ "\$(adb shell getprop sys.boot_completed | tr -d '\r')" == "1" ]]; do
            sleep 3
        done
        adb shell input keyevent 82
    """
}

task runInstrumentationTests(type: Exec) {
    dependsOn waitForBoot
    commandLine "./gradlew", "connectedDebugAndroidTest", "--stacktrace"
}

task stopEmulator(type: Exec) {
    doLast {
        exec {
            commandLine "bash", "-c", "adb emu kill || true"
        }
    }
}

task ciInstrumentationPipeline {
    dependsOn runInstrumentationTests
    finalizedBy stopEmulator
}
