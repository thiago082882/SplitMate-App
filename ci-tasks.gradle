import org.gradle.internal.os.OperatingSystem

def androidHome = System.getenv("ANDROID_HOME") ?: System.getenv("ANDROID_SDK_ROOT")
def userHome = System.getProperty("user.home")


def emulator = "${androidHome}\\emulator\\emulator.exe"
def avdManager = "${androidHome}\\cmdline-tools\\latest\\bin\\avdmanager.bat"
def sdkManager = "${androidHome}\\cmdline-tools\\latest\\bin\\sdkmanager.bat"

def avdDir = "${userHome}\\.android\\avd"
def iniPath = "${avdDir}\\CI_API_33.ini"


task installSystemImage(type: Exec) {
    commandLine sdkManager, "--install", "system-images;android-33;google_apis;x86_64"
}


task createEmulator(type: Exec) {
    dependsOn installSystemImage

    doFirst {
        // cria diretório .android/avd se não existir
        new File(avdDir).mkdirs()


        def iniFile = new File(iniPath)
        if (iniFile.exists()) {
            iniFile.delete()
        }
    }

    environment "ANDROID_SDK_HOME", userHome

    commandLine avdManager, "create", "avd",
            "--force",
            "--name", "CI_API_33",
            "--package", "system-images;android-33;google_apis;x86_64",
            "--device", "pixel"
}


task startEmulator {
    dependsOn createEmulator

    doLast {
        exec {
            commandLine emulator,
                    "@CI_API_33",
                    "-no-window",
                    "-no-audio",
                    "-no-boot-anim",
                    "-gpu", "swiftshader_indirect",
                    "-no-snapshot"
        }
    }
}


task waitForBoot(type: Exec) {
    dependsOn startEmulator

    commandLine "cmd", "/c", """
        adb wait-for-device &&
        adb shell getprop sys.boot_completed
        :check
        for /f "delims=" %%a in ('adb shell getprop sys.boot_completed') do (
            if "%%a"=="1" goto ready
        )
        timeout /t 3 >nul
        goto check
        :ready
        adb shell input keyevent 82
    """
}


task runInstrumentationTests(type: Exec) {
    dependsOn waitForBoot
    commandLine "cmd", "/c", "gradlew connectedDebugAndroidTest"
}

task stopEmulator(type: Exec) {
    doLast {
        exec {
            commandLine "cmd", "/c", "adb emu kill"
        }
    }
}


task ciInstrumentationPipeline {
    dependsOn runInstrumentationTests
    finalizedBy stopEmulator
}
