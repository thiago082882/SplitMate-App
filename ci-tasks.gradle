import org.gradle.internal.os.OperatingSystem


def isCI = System.getenv("CI") != null

def androidHome = System.getenv("ANDROID_HOME") ?: System.getenv("ANDROID_SDK_ROOT")
def userHome = System.getProperty("user.home")

def os = OperatingSystem.current()
def isWindows = os.isWindows()

def emulator = isWindows
        ? "${androidHome}\\emulator\\emulator.exe"
        : "${androidHome}/emulator/emulator"

def avdManager = isWindows
        ? "${androidHome}\\cmdline-tools\\latest\\bin\\avdmanager.bat"
        : "${androidHome}/cmdline-tools/latest/bin/avdmanager"

def sdkManager = isWindows
        ? "${androidHome}\\cmdline-tools\\latest\\bin\\sdkmanager.bat"
        : "${androidHome}/cmdline-tools/latest/bin/sdkmanager"


def avdName = "CI_API_33"
def avdDir = "${userHome}/.android/avd"
def iniPath = "${avdDir}/${avdName}.ini"


task installSystemImage(type: Exec) {
    commandLine sdkManager,
            "--install",
            "system-images;android-33;google_apis;x86_64"
}


task createEmulator(type: Exec) {
    dependsOn installSystemImage

    doFirst {
        new File(avdDir).mkdirs()

        def iniFile = new File(iniPath)
        if (iniFile.exists()) {
            iniFile.delete()
        }
    }

    environment "ANDROID_SDK_HOME", userHome

    commandLine avdManager,
            "create", "avd",
            "--force",
            "--name", avdName,
            "--package", "system-images;android-33;google_apis;x86_64",
            "--device", "pixel"
}


task startEmulator {
    dependsOn createEmulator

    doLast {
        exec {
            commandLine emulator,
                    "@${avdName}",
                    "-no-window",
                    "-no-audio",
                    "-no-boot-anim",
                    "-gpu", "swiftshader_indirect",
                    "-no-snapshot",
                    "-accel", isCI ? "off" : "auto",
                    "-partition-size", "2048"
        }
    }
}

task waitForBoot(type: Exec) {
    dependsOn startEmulator

    if (isWindows) {
        commandLine "cmd", "/c", """
            adb wait-for-device
            :check
            for /f "delims=" %%a in ('adb shell getprop sys.boot_completed') do (
                if "%%a"=="1" goto ready
            )
            timeout /t 3 >nul
            goto check
            :ready
            adb shell input keyevent 82
        """
    } else {
        commandLine "bash", "-c", """
            adb wait-for-device
            until [[ \$(adb shell getprop sys.boot_completed | tr -d '\\r') == "1" ]]; do
              sleep 3
            done
            adb shell input keyevent 82
        """
    }
}


task runInstrumentationTests(type: Exec) {
    dependsOn waitForBoot

    commandLine isWindows
            ? ["cmd", "/c", "gradlew connectedDebugAndroidTest"]
            : ["./gradlew", "connectedDebugAndroidTest"]
}


task stopEmulator {
    doLast {
        exec {
            commandLine "adb", "emu", "kill"
        }
    }
}


task ciInstrumentationPipeline {
    dependsOn runInstrumentationTests
    finalizedBy stopEmulator
}
